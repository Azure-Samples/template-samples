<% if (useTokenCredentials) { %>
using Azure.Identity; 
<% } %>
using OpenAI;
using OpenAI.Chat;
<% if (useTokenCredentials) { %>
using System.ClientModel.Primitives;
<% } else { %>
using System.ClientModel;
<% } %>

#pragma warning disable OPENAI001

<%= csharp.valueOrEnvironment(useEnvVars, "deploymentName", "AZURE_OPENAI_DEPLOYMENT_NAME", deploymentName) %>
<%= csharp.valueOrEnvironment(useEnvVars, "endpoint", "AZURE_OPENAI_ENDPOINT", endpoint) %>
<%if (useTokenCredentials) { %>
<% } else { %>
<%= csharp.valueOrEnvironment(useEnvVars, "apiKey", "AZURE_OPENAI_API_KEY", apiKey) %>
<% } %>

<% if (endpointSuffix) { %>
endpoint = endpoint + "<%= endpointSuffix %>";
<% } %>

<% if (useTokenCredentials) { %>
BearerTokenPolicy tokenPolicy = new(
    new DefaultAzureCredential(),
    "https://cognitiveservices.azure.com/.default");

ChatClient client = new(
    authenticationPolicy: tokenPolicy,
    model: deploymentName,
    options: new OpenAIClientOptions()
    {
        Endpoint = new($"{endpoint}"),
    });
<% } else { %> 
ChatClient client = new(
    credential: new ApiKeyCredential(apiKey),
    model: deploymentName,
    options: new OpenAIClientOptions()
    {
        Endpoint = new($"{endpoint}"),
    }); 
<% } %>

<% if (extraParams) { %>
ChatCompletionOptions options = new ChatCompletionOptions{
    <% if (extraParams.temperature) { %>
    Temperature=(float)<%= extraParams.temperature %>,
    <% } %>
    <% if (extraParams.MaxOutputTokenCount) { %>
    MaxOutputTokenCount=<%= extraParams.MaxOutputTokenCount %>,
    <% } %>
    <% if (extraParams.TopP) { %>
    TopP=(float)<%= extraParams.TopP %>,
    <% } %>
    <% if (extraParams.FrequencyPenalty) { %>
    FrequencyPenalty=(float)<%= extraParams.FrequencyPenalty %>,
    <% } %>
    <% if (extraParams.PresencePenalty) { %>
    PresencePenalty=(float)<%= extraParams.PresencePenalty %>,
    <% } %>
};
<% } %>

ChatCompletion completion = client.CompleteChat(
     [
         new SystemChatMessage("You are a helpful assistant that talks like a pirate."),
         new UserChatMessage("Hi, can you help me?"),
         new AssistantChatMessage("Arrr! Of course, me hearty! What can I do for ye?"),
         new UserChatMessage("What's the best way to train a parrot?"),
     ]<% if (extraParams) { %>, options<% } %>);

Console.WriteLine($"Model={completion.Model}");
foreach (ChatMessageContentPart contentPart in completion.Content)
{
    string message = contentPart.Text;
    Console.WriteLine($"Chat Role: {completion.Role}");
    Console.WriteLine("Message:");
    Console.WriteLine(message);
}
