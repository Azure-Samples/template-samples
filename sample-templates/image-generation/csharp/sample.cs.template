<% if (useTokenCredentials) { %>
using Azure.Identity; 
<%} else { %>using Azure; 
<% } %>
using OpenAI;
using OpenAI.Images;
using System;
using System.IO;
<% if (useTokenCredentials) { %>
using System.ClientModel.Primitives;
<% } else { %>
using System.ClientModel;
<% } %>

#pragma warning disable OPENAI001

<%= csharp.valueOrEnvironment(useEnvVars, "endpoint", "AZURE_OPENAI_ENDPOINT", endpoint) %>
<%= csharp.valueOrEnvironment(useEnvVars, "deploymentName", "AZURE_OPENAI_DEPLOYMENT_NAME", deploymentName) %>
<%if (useTokenCredentials) { %>
<% } else { %>
<%= csharp.valueOrEnvironment(useEnvVars, "apiKey", "AZURE_OPENAI_API_KEY", apiKey) %>;
<% } %>

<% if (endpointSuffix) { %>
endpoint = endpoint + "<%= endpointSuffix %>";
<% } %>

<% if (useTokenCredentials) { %>
BearerTokenPolicy tokenPolicy = new(
    new DefaultAzureCredential(),
    "https://cognitiveservices.azure.com/.default");

ImageClient client = new(
    authenticationPolicy: tokenPolicy,
    model: deploymentName,
    options: new OpenAIClientOptions()
    {
        Endpoint = new($"{endpoint}"),
    });
<% } else { %> 
ImageClient client = new(
    credential: new ApiKeyCredential(apiKey),
    model: deploymentName,
    options: new OpenAIClientOptions()
    {
        Endpoint = new($"{endpoint}"),
    }
);
<% } %>

string prompt = "A cute baby polar bear";

ImageGenerationOptions options = new()
{   
    Size = GeneratedImageSize.W1024xH1024,
    <% if (deploymentName == "dall-e-3" || deploymentName == "dall-e-2") { %>
    Quality = GeneratedImageQuality.High,
    Style = GeneratedImageStyle.Vivid,
    ResponseFormat = GeneratedImageFormat.Bytes
    <% } %>
};

GeneratedImage image = client.GenerateImage(prompt, options);
BinaryData bytes = image.ImageBytes;

using FileStream stream = File.OpenWrite("output.png");
bytes.ToStream().CopyTo(stream);